<div class="resourcelist">
  <mat-menu #addlayermenu="matMenu">
    <button mat-menu-item (click)="addLayer('wmts')">WMTS</button>
    <button mat-menu-item (click)="addLayer('wms')">WMS</button>
  </mat-menu>
  <mat-card style="border-radius: unset">
    <mat-card-title>
      <div class="title-block">
        <div style="width: 50px">
          <button
            mat-icon-button
            (click)="close()"
            matTooltip="Close InfoLayer List"
            matTooltipPosition="right"
          >
            <mat-icon>arrow_back</mat-icon>
          </button>
        </div>
        <div style="flex: 1 1 auto; padding-top: 7px">Overlays</div>
      </div>
    </mat-card-title>
    <mat-card-content>
      <div style="display: flex">
        <div style="flex: 1 1 auto; padding-left: 3px">
          <mat-form-field floatLabel="always" style="width: 180px">
            <mat-label>Type to filter list</mat-label>
            <input
              #ftext
              type="text"
              matInput
              [disabled]="app.config.selections.aisFilterByShipType"
              [value]="filterText"
              (keyup)="filterKeyUp(ftext.value)"
            />
            @if(filterText) {
            <button matSuffix mat-icon-button (click)="filterKeyUp('')">
              <mat-icon>close</mat-icon>
            </button>
            }
          </mat-form-field>
        </div>
        <div>
          <button
            mat-icon-button
            (click)="initItems()"
            matTooltip="Reload Layers"
            matTooltipPosition="below"
            [disabled]="app.config.selections.aisFilterByShipType"
          >
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
        <div>
          <mat-checkbox
            #selall
            [disabled]="app.config.selections.aisFilterByShipType"
            [checked]="allSel"
            [indeterminate]="someSel"
            (change)="toggleAll($event.checked)"
            [matTooltip]="(!selall.checked || someSel) ? 'Select All' : 'Deselect All'"
            matTooltipPosition="below"
          >
          </mat-checkbox>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button
        mat-icon-button
        matTooltip="Add Layer"
        matTooltipPosition="above"
        [matMenuTriggerFor]="addlayermenu"
      >
        <mat-icon>add</mat-icon>
      </button>
      <small
        >Map layers containing dynamic information to overlay on charts.</small
      >
    </mat-card-actions>
  </mat-card>

  <div class="resources infolayers">
    @if(this.app.sIsFetching()) {
    <mat-progress-bar mode="query"></mat-progress-bar>
    } @else {
    <cdk-virtual-scroll-viewport class="vscroller" itemSize="48">
      <mat-card
        *cdkVirtualFor="let r of filteredList(); let i= index;"
        style="border-bottom: silver 1px outset; border-radius: unset"
      >
        <mat-card-content>
          <div style="display: flex">
            <div style="flex: 1 1 auto; padding-left: 7px">
              <a
                style="cursor: pointer"
                (click)="itemProperties(r[0])"
                matTooltip="Layer Properties"
                matTooltipPosition="right"
              >
                <b>{{(r[1].name)}}</b>
              </a>
            </div>
            <div style="text-align: right">
              <mat-checkbox
                [checked]="r[2]"
                (change)="itemSelect($event.checked, r[0])"
                matTooltip="Show layer"
                matTooltipPosition="left"
              >
              </mat-checkbox>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <div style="flex: auto">
            <div style="display: flex">
              <div style="flex: 1 1 auto">
                <mat-form-field style="width: 120px">
                  <mat-hint>Auto Refresh</mat-hint>
                  <mat-select
                    [(ngModel)]="r[1].values.refreshInterval"
                    (selectionChange)="setRefresh(r[0], $event.value)"
                    matTooltip="Set layer transparency"
                  >
                    @for(t of refreshOptions; track t[0]) {
                    <mat-option [value]="t[0]">{{t[1]}}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                &nbsp;
                <mat-form-field style="width: 105px">
                  <mat-hint>Opacity</mat-hint>
                  <mat-select
                    [(ngModel)]="r[1].values.opacity"
                    (selectionChange)="setOpacity(r[0], $event.value)"
                    matTooltip="Set layer opacity"
                  >
                    @for(t of opacityOptions; track t[0]) {
                    <mat-option [value]="t[0]">{{t[1]}}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            @if(r[1].values.time?.values && r[1].values.time.values.length > 0) {
            <div style="display: flex; flex-direction: column; padding: 6px 0; gap: 6px">
              <div style="display: flex; align-items: center; gap: 8px">
                <mat-icon style="font-size: 20px; width: 20px; height: 20px">schedule</mat-icon>
                <div style="flex: 1; display: flex; flex-direction: column; font-size: 13px">
                  <span>{{ formatTimeValue(getCurrentTimeValue(r[1].values.time)) }}</span>
                  <span style="font-size: 11px; color: #999">
                    @if(getTimeOffset(r[1].values.time) === 0) {
                      Current
                    } @else {
                      {{ getTimeOffset(r[1].values.time) }}h
                    }
                  </span>
                </div>
                <mat-checkbox
                  [checked]="isCurrentTime(r[1].values.time)"
                  (change)="onCurrentTimeToggle(r[0], r[1].values.time, $event.checked)"
                  matTooltip="Use most recent time"
                >
                  <span style="font-size: 12px">Current</span>
                </mat-checkbox>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="font-size: 11px; min-width: 30px">-{{ getTimeSpanHours(r[1].values.time) }}h</span>
                <mat-slider
                  style="flex: 1"
                  [min]="-getTimeSpanHours(r[1].values.time)"
                  [max]="0"
                  [step]="1"
                  discrete
                  [displayWith]="formatOffsetSliderValue.bind(this)"
                >
                  <input matSliderThumb 
                         [value]="getTimeOffset(r[1].values.time)"
                         (valueChange)="onTimeOffsetSliderChange(r[0], $event, r[1].values.time)">
                </mat-slider>
                <span style="font-size: 11px; min-width: 30px">0h</span>
              </div>
            </div>
            }
            <div style="display: flex">
              <div style="flex: 2">
                <button
                  mat-icon-button
                  (click)="itemDelete(r[0])"
                  matTooltip="Delete Layer"
                >
                  <mat-icon class="icon-warn">delete</mat-icon>
                </button>
              </div>
              <div style="flex: 2; text-align: right">
                <button
                  mat-icon-button
                  (click)="itemProperties(r[0])"
                  matTooltip="Layer Properties"
                >
                  <mat-icon>info_outline</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </mat-card-actions>
      </mat-card>
    </cdk-virtual-scroll-viewport>
    }
  </div>
</div>
